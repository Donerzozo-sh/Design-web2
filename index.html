<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="web-title">灵感矩阵 | 设计作品集</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Helvetica Now Display','Helvetica Neue',Arial,sans-serif;overflow:hidden;background:#000;color:#fff;user-select:none}
    #grid-container{width:140vw;height:140vh;display:grid;grid-template-columns:repeat(10,1fr);gap:1px}
    .grid-item{transition:transform .15s,opacity .15s,filter .15s;will-change:transform,opacity,filter;opacity:.7;transform:scale(.175)}
    .table-thumbnail{width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #4b5563}
    .admin-table-row:hover{background:#374151}
    .selected-row{background:#ef4444!important}
    /* 上传进度条 */
    .progress-bar{height:4px;background:#10b981;width:0%;transition:width .3s}
  </style>
</head>
<body class="min-h-screen relative">

<!-- 顶部控制 -->
<div id="top-content-area" class="fixed top-0 left-0 right-0 p-8 z-20 pointer-events-none">
  <div id="admin-persistent-controls" class="absolute top-8 right-8 flex space-x-4 pointer-events-auto">
    <button id="view-toggle-btn" class="hidden px-4 py-2 bg-blue-600 rounded-lg" onclick="switchView(currentView==='grid'?'table':'grid')">切换到列表编辑</button>
  </div>
  <div id="content-display" class="flex flex-col pointer-events-auto">
    <h1 id="main-title" class="text-4xl font-extrabold cursor-pointer" onclick="toggleEditMode(true)">3D&Motion Creative&Production</h1>
    <p id="sub-text" class="text-gray-400 cursor-pointer" onclick="toggleEditMode(true)">Powerd by REDesign</p>
  </div>
  <!-- 编辑面板 -->
  <div id="edit-mode-container" class="hidden bg-gray-900/90 p-6 rounded-xl shadow-2xl max-w-4xl pointer-events-auto">
    <h2 class="text-xl font-bold mb-4 text-red-400">顶部内容及视觉参数编辑 (Admin)</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm text-gray-400">网站标题</label>
        <input id="edit-web-title" type="text" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="灵感矩阵 | 设计作品集"/>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 bg-gray-800 rounded-lg">
          <label class="block text-lg font-medium mb-2">主标题</label>
          <input id="edit-title" type="text" class="w-full rounded-md bg-gray-700 text-white p-2" value="3D&Motion Creative&Production"/>
          <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
            <select id="edit-title-size" class="rounded-md bg-gray-700 text-white p-2"><option value="text-8xl">特大号</option></select>
            <select id="edit-title-weight" class="rounded-md bg-gray-700 text-white p-2"><option value="font-extrabold">极粗</option></select>
            <input id="edit-title-color-picker" type="color" class="h-10 rounded-md bg-gray-700 p-1" value="#FFFFFF"/>
            <select id="edit-title-spacing" class="rounded-md bg-gray-700 text-white p-2"><option value="tracking-normal">默认间距</option></select>
          </div>
        </div>
        <div class="p-4 bg-gray-800 rounded-lg">
          <label class="block text-lg font-medium mb-2">副标题</label>
          <input id="edit-subtitle" type="text" class="w-full rounded-md bg-gray-700 text-white p-2" value="Powerd by REDesign"/>
          <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
            <select id="edit-subtitle-size" class="rounded-md bg-gray-700 text-white p-2"><option value="text-2xl">大号</option></select>
            <select id="edit-subtitle-weight" class="rounded-md bg-gray-700 text-white p-2"><option value="font-normal">默认</option></select>
            <input id="edit-subtitle-color-picker" type="color" class="h-10 rounded-md bg-gray-700 p-1" value="#9CA3AF"/>
            <select id="edit-subtitle-spacing" class="rounded-md bg-gray-700 text-white p-2"><option value="tracking-normal">默认间距</option></select>
          </div>
        </div>
      </div>
      <div class="p-4 bg-gray-800 rounded-lg">
        <label class="block text-lg font-medium mb-4">网格视觉参数</label>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 text-sm">
          <div><label class="block text-gray-400">鱼眼半径 (px)</label><input id="edit-fisheye-radius" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="300" /></div>
          <div><label class="block text-gray-400">衰减幅度</label><input id="edit-decay-power" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="2.0" /></div>
          <div><label class="block text-gray-400">初始大小</label><input id="edit-min-scale" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="0.175" /></div>
          <div><label class="block text-gray-400">最大放大倍数</label><input id="edit-max-scale" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="3.0" /></div>
          <div><label class="block text-gray-400">动画平滑度</label><input id="edit-parallax-smoothing" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="0.2" /></div>
          <div><label class="block text-gray-400">图片间距 (px)</label><input id="edit-grid-gap" type="number" class="w-full mt-1 rounded-md bg-gray-700 text-white p-2" value="1" /></div>
        </div>
      </div>
      <div class="flex space-x-4 mt-6">
        <button class="px-4 py-2 bg-red-600 text-white rounded-lg" onclick="saveContent()">保存更改</button>
        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg" onclick="toggleEditMode(false)">取消</button>
      </div>
    </div>
  </div>

  <!-- 表格视图 -->
  <div id="admin-table-view" class="fixed inset-0 p-12 z-10 hidden overflow-auto">
    <h1 class="text-3xl font-bold mb-4 text-red-400">网格素材列表编辑（共 60 项）</h1>
    <div id="admin-table-container"></div>
  </div>

  <!-- 网格 -->
  <div id="grid-container" class="absolute inset-0 m-auto grid"></div>

  <!-- 视频模态框 -->
  <div id="video-modal" class="fixed inset-0 bg-black/90 flex justify-center items-center hidden z-50">
    <div class="relative w-full max-w-4xl aspect-video rounded-xl overflow-hidden">
      <video id="video-player" class="w-full h-full object-cover" controls autoplay playsinline></video>
      <button id="close-modal" class="absolute top-4 right-4 text-white p-2 rounded-full bg-black/50">✕</button>
    </div>
  </div>

  <!-- 版权 & 管理员入口 -->
  <div id="admin-toggle-btn" class="fixed bottom-4 right-4 z-50 text-gray-400 text-sm pointer-events-auto">
    2025 <span class="cursor-pointer hover:text-white" onclick="handleAdminToggle()">©</span> All Rights Reserved By REDesign
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ==================== 配置区 ====================
    const firebaseConfig = {
      apiKey: "AIzaSyDApuOEfnj7x-7lg7T-3xceKQMlRvcdJV68",
      authDomain: "design-c9479.firebaseapp.com",
      projectId: "design-c9479",
      storageBucket: "design-c9479.firebasestorage.app",
      messagingSenderId: "779638854632",
      appId: "1:779638854632:web:cd467e5c88cb87c2de0a5d",
      measurementId: "G-RRL6LEV1NV"
    };
    const appId = "design-c9479";
    // ================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let isLocalMode = false;
    let isAdminMode = false;
    let currentView = 'grid';
    let selectedItemId = null;
    let isFocusMode = false;

    const NUM_COLS = 10;
    const NUM_ROWS = 6;
    const TOTAL_ITEMS = NUM_COLS * NUM_ROWS;
    const PLACEHOLDER_VID = "https://www.w3schools.com/html/mov_bbb.mp4";

    let items = [];
    let itemData = {};
    let mousePos = { x: 0, y: 0 };
    let isMouseActive = false;
    let animationFrameId = null;
    let parallaxOffset = { x: 0, y: 0 };

    const DEFAULT_CONTENT = {
      title: "3D&Motion Creative&Production",
      subtitle: "Powerd by REDesign",
      webTitle: "灵感矩阵 | 设计作品集",
      titleStyle: { size: 'text-8xl', weight: 'font-extrabold', color: '#FFFFFF', spacing: 'tracking-normal' },
      subtitleStyle: { size: 'text-2xl', weight: 'font-normal', color: '#9CA3AF', spacing: 'tracking-normal' }
    };

    const GRID_COLORS = ['#EF4444','#F97316','#F59E0B','#10B981','#3B82F6','#6366F1','#8B5CF6','#EC4899','#FBBF24','#A78BFA','#4ADE80','#FB7185','#D946EF','#06B6D4'];

    function getColumnIndex(index) { return index % NUM_COLS; }
    function getColorForColumn(colIndex) { return GRID_COLORS[colIndex % GRID_COLORS.length]; }

    const getSettingsDocPath = () => `/artifacts/${appId}/public/data/homepage_content/settings`;
    const getGridCollectionPath = () => `/artifacts/${appId}/public/data/grid_items`;

    // ==================== 管理员相关 ====================
    window.setAdminMode = (mode) => {
      isAdminMode = mode;
      const sym = document.querySelector('#admin-toggle-btn span');
      const bar = document.getElementById('top-content-area');
      const btn = document.getElementById('view-toggle-btn');
      if (mode) {
        sym.classList.add('text-red-400');
        sym.classList.remove('text-gray-400');
        bar.classList.add('border-b-4', 'border-red-600');
        btn.classList.remove('hidden');
        window.switchView('grid');
      } else {
        sym.classList.remove('text-red-400');
        sym.classList.add('text-gray-400');
        bar.classList.remove('border-b-4', 'border-red-600');
        btn.classList.add('hidden');
        resetFocusAndScale();
      }
    };
    window.handleAdminToggle = () => isAdminMode ? window.setAdminMode(false) : window.openAuthModal();
    window.openAuthModal = () => {
      document.getElementById('auth-error-message').classList.add('hidden');
      document.getElementById('auth-password').value = '';
      document.getElementById('auth-modal').classList.remove('hidden');
    };
    window.closeAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');
    window.handleAdminLogin = () => {
      const u = document.getElementById('auth-username').value.trim();
      const p = document.getElementById('auth-password').value.trim();
      if (u === 'admin' && p === '1234') {
        window.setAdminMode(true);
        window.closeAuthModal();
      } else {
        document.getElementById('auth-error-message').classList.remove('hidden');
      }
    };
    window.switchView = (view) => {
      if (!isAdminMode) return;
      currentView = view;
      const gridEl = document.getElementById('grid-container');
      const tableEl = document.getElementById('admin-table-view');
      const btn = document.getElementById('view-toggle-btn');
      if (view === 'table') {
        isFocusMode = false;
        gridEl.classList.add('hidden');
        tableEl.classList.remove('hidden');
        renderAdminTable();
        btn.textContent = '返回网格视图';
      } else {
        resetFocusAndScale();
        gridEl.classList.remove('hidden');
        tableEl.classList.add('hidden');
        btn.textContent = '切换到列表编辑';
      }
    };
    window.toggleEditMode = (enable) => {
      if (!isAdminMode) return;
      const panel = document.getElementById('edit-mode-container');
      const display = document.getElementById('content-display');
      if (enable) {
        display.classList.add('hidden');
        panel.classList.remove('hidden');
      } else {
        display.classList.remove('hidden');
        panel.classList.add('hidden');
      }
    };
    window.saveContent = async () => {
      if (!isAdminMode || isLocalMode) return;
      const docRef = doc(db, getSettingsDocPath());
      await setDoc(docRef, {
        webTitle: document.getElementById('edit-web-title').value.trim() || DEFAULT_CONTENT.webTitle,
        title: document.getElementById('edit-title').value.trim() || DEFAULT_CONTENT.title,
        subtitle: document.getElementById('edit-subtitle').value.trim() || DEFAULT_CONTENT.subtitle,
        titleStyle: {
          size: document.getElementById('edit-title-size').value,
          weight: document.getElementById('edit-title-weight').value,
          color: document.getElementById('edit-title-color-picker').value,
          spacing: document.getElementById('edit-title-spacing').value,
        },
        subtitleStyle: {
          size: document.getElementById('edit-subtitle-size').value,
          weight: document.getElementById('edit-subtitle-weight').value,
          color: document.getElementById('edit-subtitle-color-picker').value,
          spacing: document.getElementById('edit-subtitle-spacing').value,
        },
        fisheyeSettings: {
          radius: parseFloat(document.getElementById('edit-fisheye-radius').value),
          decayPower: parseFloat(document.getElementById('edit-decay-power').value),
          minScale: parseFloat(document.getElementById('edit-min-scale').value),
          maxScale: parseFloat(document.getElementById('edit-max-scale').value),
          parallaxSmoothing: parseFloat(document.getElementById('edit-parallax-smoothing').value),
          gridGap: parseInt(document.getElementById('edit-grid-gap').value),
        },
        timestamp: new Date()
      });
      window.toggleEditMode(false);
    };

    // ==================== 表格渲染 & 保存（修复版） ====================
    window.saveInlineItemChange = async (itemId, imgInputId, vidInputId, saveButton) => {
      const imgInput = document.getElementById(imgInputId);
      const vidInput = document.getElementById(vidInputId);
      if (!imgInput || !vidInput) return;

      const newImg = imgInput.value.trim();
      const newVid = vidInput.value.trim();

      if (isLocalMode || !db || !appId) return alert("本地模式无法保存");
      if (!isAdminMode) return alert("请先登录管理员");

      // GitHub → Raw 自动转换
      const convertGitHubToRawURL = (url) => {
        try {
          const m = url.match(/^https:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/(.+)$/);
          if (m) return `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}`;
        } catch {}
        return url;
      };

      const rawImgURL = convertGitHubToRawURL(newImg);

      const itemIndex = parseInt(itemId.split('_')[1]);
      const colIndex = getColumnIndex(itemIndex);
      const defaultColor = getColorForColumn(colIndex);

      const dataToSave = {
        vid: newVid || PLACEHOLDER_VID,
        bgColor: itemData[itemId]?.bgColor || defaultColor,
        img: rawImgURL, // 强制写入字符串，不再 null
      };

      saveButton.disabled = true;
      saveButton.textContent = "保存中...";
      saveButton.className = "px-3 py-1 bg-gray-500 text-white rounded-lg";

      try {
        await updateDoc(doc(db, getGridCollectionPath(), itemId), dataToSave);
        itemData[itemId] = { ...itemData[itemId], ...dataToSave };
        const preview = document.querySelector(`#row-${itemId} .table-thumbnail`);
        if (preview) preview.src = rawImgURL || `https://placehold.co/60x60/${defaultColor.slice(1)}/FFFFFF?text=${itemIndex}`;
        saveButton.textContent = "已保存";
        saveButton.className = "px-3 py-1 bg-green-600 text-white rounded-lg";
      } catch (e) {
        console.error(e);
        saveButton.textContent = "保存失败";
        saveButton.className = "px-3 py-1 bg-red-600 text-white rounded-lg";
      } finally {
        setTimeout(() => {
          saveButton.disabled = false;
          saveButton.textContent = "保存";
          saveButton.className = "px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700";
        }, 1200);
      }
    };

    // ===== 新增：Firebase Storage 上传 =====
    /**
     * 上传文件到 Firebase Storage 并返回公开 URL
     * @param {File} file 文件对象
     * @param {string} folder 存储文件夹名（images / videos）
     * @returns {Promise<string>} 公开下载 URL
     */
    async function uploadFileAndGetURL(file, folder = 'uploads') {
      if (!file) return '';
      const ext = file.name.split('.').pop();
      const path = `${folder}/${Date.now()}.${ext}`;
      const storageRef = ref(storage, path);
      const task = uploadBytesResumable(storageRef, file);

      // 可选：监听进度（这里简单跳过，直接 await）
      await task;
      return await getDownloadURL(storageRef); // 返回 https://firebasestorage.googleapis.com/...
    }

    // 为每行绑定「上传文件」事件（委托到 table 容器，动态行也可用）
    window.setupUploadListeners = () => {
      const tableContainer = document.getElementById('admin-table-container');
      tableContainer.addEventListener('change', async (e) => {
        if (!e.target.matches('input[type=file].upload-file-input')) return;
        const file = e.target.files[0];
        if (!file) return;

        const itemId = e.target.dataset.itemId;
        const type = e.target.dataset.type; // 'img' | 'vid'
        const saveBtn = document.querySelector(`#row-${itemId} .save-btn`);
        const progress = document.querySelector(`#row-${itemId} .progress-bar`);

        // 上传并获取 URL
        saveBtn.textContent = '上传中...';
        saveBtn.disabled = true;
        progress.style.width = '0%';
        try {
          const url = await uploadFileAndGetURL(file, type === 'img' ? 'images' : 'videos');
          // 把 URL 填入对应输入框
          const input = document.getElementById(`${type}-input-${itemId}`);
          input.value = url;
          // 立即保存到 Firestore（复用原函数）
          await window.saveInlineItemChange(itemId, `${type}-input-${itemId}`, `vid-input-${itemId}`, saveBtn);
        } catch (err) {
          console.error(err);
          alert('上传失败：' + err.message);
          saveBtn.textContent = '保存';
          saveBtn.disabled = false;
        } finally {
          progress.style.width = '0%';
        }
      });
    };

    window.selectItem = (itemId, rowElement) => {
      if (!isAdminMode) return;
      document.querySelectorAll('.admin-table-row').forEach(r => r.classList.remove('selected-row'));
      rowElement.classList.add('selected-row');
      selectedItemId = itemId;
      isFocusMode = true;
      isMouseActive = true;
      startAnimationLoop();
      const item = items.find(i => i.el.dataset.videoId === itemId);
      if (!item) return;
      const vx = window.innerWidth / 2;
      const vy = window.innerHeight / 2;
      parallaxOffset.x = vx - item.center.x;
      parallaxOffset.y = vy - item.center.y;
      applyGridTransform();
    };

    function renderAdminTable() {
      const container = document.getElementById('admin-table-container');
      let html = `
        <div class="overflow-x-auto h-[80vh] bg-gray-900/90 p-4 rounded-xl shadow-2xl">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="sticky top-0 bg-gray-900/95">
              <tr>
                <th class="px-3 py-3 text-left text-xs uppercase">ID</th>
                <th class="px-3 py-3 text-left text-xs uppercase">预览</th>
                <th class="px-3 py-3 text-left text-xs uppercase">位置</th>
                <th class="px-3 py-3 text-left text-xs uppercase">图片 URL</th>
                <th class="px-3 py-3 text-left text-xs uppercase">视频 URL</th>
                <th class="px-3 py-3 text-left text-xs uppercase">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-800">
      `;
      for (let i = 0; i < TOTAL_ITEMS; i++) {
        const itemId = `item_${i}`;
        const data = itemData[itemId] || { img: '', vid: PLACEHOLDER_VID, bgColor: getColorForColumn(getColumnIndex(i)) };
        const imgUrl = data.img || '';
        const displayImg = imgUrl || `https://placehold.co/60x60/${data.bgColor.slice(1)}/FFFFFF?text=${i}`;
        const isSelected = selectedItemId === itemId ? 'selected-row' : '';
        html += `<tr id="row-${itemId}" class="admin-table-row text-gray-300 cursor-pointer ${isSelected}" onclick="selectItem('${itemId}', this)">
          <td class="px-3 py-2 text-sm">${i}</td>
          <td class="px-3 py-2"><img src="${displayImg}" class="table-thumbnail" onerror="this.src='https://placehold.co/60x60/374151/FFFFFF?text=${i}'" alt="Item ${i}" /></td>
          <td class="px-3 py-2"><div class="w-[60px] h-[45px] grid gap-[1px] bg-gray-900 border border-gray-700 rounded-sm overflow-hidden" style="grid-template-columns:repeat(${NUM_COLS},1fr);grid-template-rows:repeat(${NUM_ROWS},1fr);">${Array.from({length:TOTAL_ITEMS},(_,j)=>`<div class="w-full h-full" style="background-color:${j===i?data.bgColor:'#374151'}"></div>`).join('')}</div></td>
          <td class="px-3 py-2 text-sm max-w-sm">
            <input id="img-input-${itemId}" type="text" value="${imgUrl}" placeholder="Image URL" class="w-full text-xs rounded-md bg-gray-700 text-white p-1" />
            <div class="flex items-center mt-2 space-x-2">
              <input type="file" class="upload-file-input hidden" data-item-id="${itemId}" data-type="img" accept="image/*" />
              <button class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="this.previousElementSibling.click()">上传图片</button>
              <div class="progress-bar flex-1 rounded"></div>
            </div>
          </td>
          <td class="px-3 py-2 text-sm max-w-sm">
            <input id="vid-input-${itemId}" type="text" value="${data.vid}" placeholder="Video URL" class="w-full text-xs rounded-md bg-gray-700 text-white p-1" />
            <div class="flex items-center mt-2 space-x-2">
              <input type="file" class="upload-file-input hidden" data-item-id="${itemId}" data-type="vid" accept="video/*" />
              <button class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="this.previousElementSibling.click()">上传视频</button>
              <div class="progress-bar flex-1 rounded"></div>
            </div>
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-sm">
            <button class="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 save-btn" onclick="event.stopPropagation(); saveInlineItemChange('${itemId}', 'img-input-${itemId}', 'vid-input-${itemId}', this);">保存</button>
          </td>
        </tr>`;
      }
      html += '</tbody></table></div>';
      container.innerHTML = html;
      window.setupUploadListeners(); // 绑定上传事件
    }

    // ==================== 动画 & 交互 ====================
    function cacheItemPositions() {
      if (!gridContainer) return;
      const old = gridContainer.style.transform;
      gridContainer.style.transform = '';
      items.forEach(item => {
        const rect = item.el.getBoundingClientRect();
        item.center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
      });
      gridContainer.style.transform = old;
    }
    function applyGridTransform() {
      if (!gridContainer) return;
      gridContainer.style.transform = `translate3d(${parallaxOffset.x}px, ${parallaxOffset.y}px, 0)`;
    }
    function resetGridScale() {
      items.forEach(item => {
        item.el.style.transform = `scale(0.175)`;
        item.el.style.opacity = '0.7';
        item.el.style.zIndex = 1;
        item.el.style.filter = 'brightness(1)';
      });
    }
    function resetFocusAndScale() {
      isFocusMode = false;
      selectedItemId = null;
      resetGridScale();
      resetGrid();
      document.querySelectorAll('.admin-table-row').forEach(r => r.classList.remove('selected-row'));
      isMouseActive = true;
      startAnimationLoop();
    }
    function resetGrid() {
      parallaxOffset = { x: 0, y: 0 };
      applyGridTransform();
    }
    function startAnimationLoop() {
      if (!animationFrameId) animationFrameId = requestAnimationFrame(updateFisheyeEffect);
    }
    function updateFisheyeEffect() {
      if (!gridContainer) { animationFrameId = null; return; }
      const vx = window.innerWidth / 2;
      const vy = window.innerHeight / 2;
      if (!isFocusMode) {
        const tx = (mousePos.x - vx) * 0.1;
        const ty = (mousePos.y - vy) * 0.1;
        parallaxOffset.x += (tx - parallaxOffset.x) * 0.2;
        parallaxOffset.y += (ty - parallaxOffset.y) * 0.2;
      } else {
        const item = items.find(i => i.el.dataset.videoId === selectedItemId);
        if (item) {
          const tx = vx - item.center.x;
          const ty = vy - item.center.y;
          parallaxOffset.x += (tx - parallaxOffset.x) * 0.05;
          parallaxOffset.y += (ty - parallaxOffset.y) * 0.05;
        }
      }
      applyGridTransform();

      if (isAdminMode && currentView === 'table') { animationFrameId = requestAnimationFrame(updateFisheyeEffect); return; }

      const fx = mousePos.x;
      const fy = mousePos.y;
      const radius = 300;
      const minScale = 0.175;
      const maxScale = 3.0;
      const decayPower = 2.0;
      const focusScale = maxScale * 1.5;

      items.forEach(item => {
        const cx = item.center.x + parallaxOffset.x;
        const cy = item.center.y + parallaxOffset.y;
        let scale, opacity, zIndex = 1, brightness = 1;
        if (isFocusMode && item.el.dataset.videoId === selectedItemId) {
          scale = focusScale;
          opacity = 1;
          zIndex = 100;
          brightness = 1;
        } else if (isFocusMode) {
          scale = minScale * 0.5;
          opacity = 0.2;
          brightness = 0.5;
        } else {
          const dx = fx - cx;
          const dy = fy - cy;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist >= radius) {
            opacity = 0.7;
            item.twinklePhase += (0.02 + Math.random() * 0.01) * item.twinkleSpeed;
            const sine = (Math.sin(item.twinklePhase) + 1) / 2;
            brightness = 0.2 + (1.2) * sine;
            const twinkleScale = minScale * 0.7 + (minScale * 0.6) * sine;
            scale = twinkleScale;
          } else {
            const prox = 1 - (dist / radius);
            const eased = 1 - Math.pow(1 - prox, decayPower);
            scale = minScale + (maxScale - minScale) * eased;
            opacity = 0.7 + (1 - 0.7) * eased;
            zIndex = 2 + Math.floor(prox * 8);
            brightness = 1;
          }
        }
        item.el.style.transform = `translateZ(0) scale(${scale})`;
        item.el.style.opacity = opacity;
        item.el.style.zIndex = zIndex;
        item.el.style.filter = `brightness(${brightness})`;
      });

      if (isMouseActive) animationFrameId = requestAnimationFrame(updateFisheyeEffect);
      else animationFrameId = null;
    }

    // ==================== 网格初始化 ====================
    async function initializeDefaultGridData() {
      if (isLocalMode) {
        for (let i = 0; i < TOTAL_ITEMS; i++) {
          const itemId = `item_${i}`;
          itemData[itemId] = { img: null, vid: PLACEHOLDER_VID, bgColor: getColorForColumn(getColumnIndex(i)) };
        }
        return;
      }
      const colRef = collection(db, getGridCollectionPath());
      const snap = await getDocs(colRef);
      if (snap.empty) {
        for (let i = 0; i < TOTAL_ITEMS; i++) {
          const itemId = `item_${i}`;
          itemData[itemId] = { img: null, vid: PLACEHOLDER_VID, bgColor: getColorForColumn(getColumnIndex(i)) };
          if (i < 5) await setDoc(doc(db, getGridCollectionPath(), itemId), itemData[itemId]);
        }
      } else {
        snap.docs.forEach(d => {
          const data = d.data();
          const i = parseInt(d.id.split('_')[1]);
          if (i >= TOTAL_ITEMS) return;
          itemData[d.id] = { img: data.img || null, vid: data.vid || PLACEHOLDER_VID, bgColor: data.bgColor || getColorForColumn(getColumnIndex(i)) };
        });
        for (let i = 0; i < TOTAL_ITEMS; i++) {
          const itemId = `item_${i}`;
          if (!itemData[itemId]) itemData[itemId] = { img: null, vid: PLACEHOLDER_VID, bgColor: getColorForColumn(getColumnIndex(i)) };
        }
      }
    }

    function createGrid() {
      if (items.length || !gridContainer) return;
      gridContainer.innerHTML = '';
      gridContainer.style.gridTemplateColumns = `repeat(${NUM_COLS}, 1fr)`;
      gridContainer.style.gap = '1px';
      for (let i = 0; i < TOTAL_ITEMS; i++) {
        const itemId = `item_${i}`;
        const data = itemData[itemId];
        const el = document.createElement('div');
        el.className = 'grid-item aspect-square bg-cover bg-center cursor-pointer';
        if (data.img) {
          el.style.backgroundImage = `url(${data.img})`;
          el.style.backgroundColor = 'transparent';
        } else {
          el.style.backgroundColor = data.bgColor;
        }
        el.dataset.videoId = itemId;
        gridContainer.appendChild(el);
        el.twinklePhase = Math.random() * 2 * Math.PI;
        el.twinkleSpeed = 0.5 + Math.random() * 0.5;
        items.push({ el, center: { x: 0, y: 0 }, twinklePhase: el.twinklePhase, twinkleSpeed: el.twinkleSpeed });
      }
      cacheItemPositions();
    }

    function updateGridDOM() {
      if (!items.length || !gridContainer) return;
      gridContainer.style.gap = `${parseInt(document.getElementById('edit-grid-gap').value || 1)}px`;
      for (let i = 0; i < items.length; i++) {
        const itemId = `item_${i}`;
        const data = itemData[itemId];
        const el = items[i].el;
        if (data.img) {
          el.style.backgroundImage = `url(${data.img})`;
          el.style.backgroundColor = 'transparent';
        } else {
          el.style.backgroundImage = 'none';
          el.style.backgroundColor = data.bgColor;
        }
        if (!el.style.transform.includes('scale(') || el.style.transform.includes('scale(0.')) {
          el.style.transform = `scale(${parseFloat(document.getElementById('edit-min-scale').value) || 0.175})`;
        }
      }
    }

    // ==================== 内容监听器 ====================
    window.setupContentListener = (firestore) => {
      const docRef = doc(firestore, getSettingsDocPath());
      onSnapshot(docRef, (snap) => {
        const data = snap.exists() ? snap.data() : {};
        document.title = data.webTitle || DEFAULT_CONTENT.webTitle;
        document.getElementById('main-title').textContent = data.title || DEFAULT_CONTENT.title;
        document.getElementById('sub-text').textContent = data.subtitle || DEFAULT_CONTENT.subtitle;
        applyTextStyles(document.getElementById('main-title'), data.titleStyle || DEFAULT_CONTENT.titleStyle, true);
        applyTextStyles(document.getElementById('sub-text'), data.subtitleStyle || DEFAULT_CONTENT.subtitleStyle, false);
      });
    };

    window.setupGridListener = (firestore) => {
      const colRef = collection(firestore, getGridCollectionPath());
      onSnapshot(colRef, (snap) => {
        let initial = Object.keys(itemData).length === 0;
        snap.docChanges().forEach(chg => {
          const data = chg.doc.data();
          const id = chg.doc.id;
          const i = parseInt(id.split('_')[1]);
          if (i >= TOTAL_ITEMS) return;
          itemData[id] = { img: data.img || null, vid: data.vid || PLACEHOLDER_VID, bgColor: data.bgColor || getColorForColumn(getColumnIndex(i)) };
        });
        if (initial) createGrid();
        else updateGridDOM();
      }, async () => {
        if (Object.keys(itemData).length === 0) {
          await initializeDefaultGridData();
          createGrid();
        }
      });
    };

    function applyTextStyles(el, style, isTitle) {
      if (!el || !style) return;
      el.className = el.className.split(' ').filter(c => !c.startsWith('text-') && !c.startsWith('font-') && !c.startsWith('tracking-')).join(' ');
      if (style.size) el.classList.add(style.size);
      if (style.weight) el.classList.add(style.weight);
      if (style.spacing) el.classList.add(style.spacing);
      el.style.color = style.color || (isTitle ? '#fff' : '#9ca3af');
    }

    // ==================== 视频模态框 ====================
    function openVideoModal(src) {
      const modal = document.getElementById('video-modal');
      const player = document.getElementById('video-player');
      player.src = src;
      modal.classList.remove('hidden');
      player.play().catch(() => {});
    }
    function closeVideoModalFunc() {
      const modal = document.getElementById('video-modal');
      const player = document.getElementById('video-player');
      modal.classList.add('hidden');
      player.pause();
      player.src = '';
      resetFocusAndScale();
    }

    // ==================== 事件绑定 ====================
    function setupDOMAndListeners() {
      gridContainer = document.getElementById('grid-container');
      document.getElementById('close-modal').addEventListener('click', closeVideoModalFunc);
      document.getElementById('video-modal').addEventListener('click', (e) => e.target.id === 'video-modal' && closeVideoModalFunc());
      gridContainer.addEventListener('click', (e) => {
        const itemEl = e.target.closest('.grid-item');
        if (itemEl) {
          const itemId = itemEl.dataset.videoId;
          if (isAdminMode) {
            window.switchView('table');
            const row = document.getElementById(`row-${itemId}`);
            if (row) {
              window.selectItem(itemId, row);
              row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
          }
          isMouseActive = false;
          openVideoModal(itemData[itemId]?.vid || PLACEHOLDER_VID);
        }
      });
      window.addEventListener('mousemove', (e) => {
        if (currentView === 'grid' && !isFocusMode) {
          mousePos.x = e.clientX;
          mousePos.y = e.clientY;
          if (!isMouseActive) {
            isMouseActive = true;
            startAnimationLoop();
          }
        }
      });
      window.addEventListener('mouseleave', () => {
        if (!isFocusMode) {
          isMouseActive = false;
          resetGrid();
        }
      });
      window.addEventListener('resize', () => {
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(() => {
          cacheItemPositions();
          if (isFocusMode && selectedItemId) {
            const row = document.getElementById(`row-${selectedItemId}`);
            if (row) window.selectItem(selectedItemId, row);
          }
        }, 100);
      });
    }

    // ==================== 启动 ====================
    window.setupApp = async () => {
      setupDOMAndListeners();
      await signInAnonymously(auth);
      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.setupContentListener(db);
          window.setupGridListener(db);
        }
      });
    };

    window.addEventListener('load', window.setupApp);
  </script>
</body>
</html>
